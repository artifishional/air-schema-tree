<unit>

  <unit key = tap-handler >

    <view-source>

      import { stream } from "m2";

      class EventHandler {
        constructor() {
          this.started = {x: 0, y: 0};
        }
        handleEvent(event) {
          if(event.type === "pointerdown") {
            this.started = { x: event.x, y: event.y };
          }
          else if(event.type === "pointerup") {
            if(this.started.x === event.x && this.started.y === event.y) {
              event.currentTarget.dispatchEvent(new CustomEvent("tap"));
            }
          }
        }
      }

      export default ({ targets, source }) =>
        stream((emt, { sweep, over }) => {
          const handler = new EventHandler();
          targets.map( ({ node }) => node.addEventListener("pointerup", handler) );
          targets.map( ({ node }) => node.addEventListener("pointerdown", handler) );
          sweep.add(() => {
            targets.map( ({ node }) => node.removeEventListener("pointerup", handler) );
            targets.map( ({ node }) => node.removeEventListener("pointerdown", handler) );
          });
          over.add(source.on(emt));
        });

    </view-source>

  </unit>

  <stream-source>
    import { stream, ModelVertex } from "m2";
    import { sort } from "nr-graph";
    import Parser from "../parser";

    export default ({ schema }) =>
      stream((emt, { sweep, hook }) => {

        let state = {
          units: [{ id: "$", x: 0, y: 0 }],
          lines: [],
          entities: [],
          currentSource: { actions: [], requests: [] },
          sources: {},
          wall: false
        };

        emt([state]);

        hook.add(({ action, signature }) => {
          if (action === "node-click") {
            emt.kf();
            emt([
              (state = {
                ...state,
                currentSource: state.sources[signature.id],
                wall: true
              })
            ]);
          } else if (action === "wall-click") {
            emt.kf();
            emt([(state = { ...state, currentSource: { actions: [], requests: [] }, wall: false })]);
          }
        });

        sweep.add(
          schema.get("@$").at(root => {
            ModelVertex.observe(root, data => {
              const graph = new Parser().parseData(root);
              const units = sort({ graph });
              const sources = graph.nodes.reduce((acc, { name, source }) => {
                acc[name] = source;
                return acc;
              }, {});

              emt.kf();
              emt([
                (state = {
                  ...state,
                  units: units.map( ( { id, ...unit } ) => ({
                    id,
                    ...unit,
                    entities: graph.getNode(id).entities,
                  }) ),
                  sources,
                  lines: units.reduce((acc, { parentId, id, x, y }) => {
                    if (parentId) {
                      const { x: x2, y: y2 } = units.find(({ id }) => id === parentId);
                      acc.push({ id, x1: x, y1: y, x2, y2 });
                    }
                    return acc;
                  }, [])
                })
              ]);
            });
          })
        );
      });
  </stream-source>

  <unit>
    <style type="text/scss">
      svg {
        user-select: none;
      }

      line {
        stroke: white;
        stroke-width: 1;
      }

      body {
        overflow: hidden;
        padding: 0;
        margin: 0;
        background-color: #040a1b;
      }

      .model {
        fill: #0066cc;

        &-entities {
          fill: #ff3333;

          text {
            font-family: Verdana, sans-serif;
            font-size: 8px;
            fill: yellow;
            stroke: none;
            dominant-baseline: middle;
          }
        }

        text {
          stroke: none;
          font-size: 1px;
          font-family: Verdana, sans-serif;
          fill: white;
          dominant-baseline: middle;
        }
      }

      .wall {
        stroke: none;
        fill: rgba(0, 0, 0, 0.7);
      }
    </style>

    <view-source>
      import svgPanZoom from "svg-pan-zoom";
      import { stream } from "m2";

      export default ({ targets: [{ node: svg }], source }) => {
        svg.setAttribute("width", window.screen.width);
        svg.setAttribute("height", window.screen.height);
        return stream((emt, { hook, sweep, over }) => {
          let instance = null;
          const observer = new MutationObserver(() => {
            if (!instance && document.contains(svg)) {
              instance = svgPanZoom(svg, {
                refreshRate: "auto",
                viewportSelector: "g",
                zoomScaleSensitivity: 0.25,
                dblClickZoomEnabled: false,
                fit: true,
                minZoom: 0.25,
                maxZoom: 3
              });
            }
          });
          observer.observe(document, { childList: true, subtree: true });

          sweep.add(() => {
            if (instance) {
              observer.disconnect();
              instance.destroy();
              instance = null;
            }
          });
          over.add(source.on(emt));
        });
      };
    </view-source>

    <svg>
      <g>
        <unit kit="(lines){id}">
          <keyframe>
            <key prop="{ x1: (x1), y1: (y1), x2: (x2), y2: (y2) }"></key>
          </keyframe>
          <line></line>
        </unit>
        <unit kit="(units){id}" use = @tap-handler on:tap="req('node-click', { signature })">
          <keyframe>
            <key prop="{ translateX: (x), translateY: (y) }"></key>
          </keyframe>
          <g class="model">
            <unit>
              <keyframe>
                <key prop="{ scale: (r) }"></key>
              </keyframe>
              <g>
                <circle r="1"></circle>
                <g transform="scale(0.5)">
                  <text text-anchor="middle">
                    <unit>{(id)}</unit>
                  </text>
                </g>
                <g transform="translate(0.7,0.7)">
                  <unit>
                    <style>
                      :scope {
                        stroke-width: 0.02;
                        stroke: #fff;
                        fill: #0066cc;
                      }
                    </style>
                    <circle r="0.4"></circle>
                  </unit>
                  <g transform="scale(0.3)">
                    <text text-anchor="middle">
                      <unit>{(entities)}</unit>
                    </text>
                  </g>
                </g>
              </g>
            </unit>
          </g>
        </unit>
      </g>
      <unit tee="{ wall }" onclick="req('wall-click')">
        <rect class="wall" x="0" y="0" width="100%" height="100%"></rect>
      </unit>
    </svg>
  </unit>

  <unit tee="{ wall }">
    <style type="text/scss">

      :scope {
        --colors-first-main-type: #0066cc;
        --colors-second-type: mediumvioletred;
      }

      ::-webkit-scrollbar {
        width: 5px;
      }

      ::-webkit-scrollbar-track {
        background: none;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--colors-second-type);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--colors-second-type);
      }

      pre {
        margin: 1em 0 0.5em;
      }

      #left-panel {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        padding: 15px;
        font-family: Verdana, sans-serif;
        overflow: auto;
        white-space: nowrap;
        color: ivory;
        background-color: var(--colors-first-main-type);
      }

      #name {
        font-size: 50px;
        color: #ff0097;
      }

      .title {
        font-size: 16px;
        color: #ff8f00;

        &.section {
          margin: 15px 0 10px;
          font-size: 30px;
          color: #75e1fb;
        }
      }

      .description {
        color: #0f0;
      }

      .format {
        color: #ff0;
      }

      .underground {
        margin-bottom: 10px;
        padding: 5px;
        background-color: rgba(0, 255, 100, 0.3);

        &:last-child {
          margin-bottom: 20px;
        }
      }
    </style>
    <keyframe name = fade-in prop="{ duration: 0.1, easing: 'easeOutQuad' }">
      <key offset="0" prop="{ width: '0%' }"></key>
      <key offset="1" prop="{ width: '40%' }"></key>
    </keyframe>
    <div id="left-panel">
      <div id="name">
        <unit>{(currentSource.name)}</unit>
      </div>

      <unit tee="{ currentSource: { actions: { length } } }">
        <div class="title section">Actions</div>
      </unit>
      <unit kit="(currentSource.actions){id}">
        <div class="underground">
          <div class="title">
            <unit>{(title)}</unit>
          </div>
          <div class="description">
            <pre><unit>{(description)}</unit></pre>
          </div>
          <div class="format">
            <pre><unit>{(format)}</unit></pre>
          </div>
        </div>
      </unit>

      <unit tee="{ currentSource: { requests: { length } } }">
        <div class="title section">Requests</div>
      </unit>
      <unit kit="(currentSource.requests){id}">
        <div class="underground">
          <div class="title">
            <unit>{(title)}</unit>
          </div>
          <div class="description">
            <pre><unit>{(description)}</unit></pre>
          </div>
          <div class="format">
            <pre label = pre><unit>{(format)}</unit></pre>
          </div>
        </div>
      </unit>
    </div>
  </unit>
</unit>
